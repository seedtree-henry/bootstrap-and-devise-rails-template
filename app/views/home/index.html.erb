<h1>Welcome, <%= current_user.email %></h1>
<div id="calendar"></div>

<%= javascript_tag "let events = #{@events.to_json}" %>
<%= javascript_tag "const user_id = #{current_user.id}" %>
<script>
  console.log(events);
  $(document).ready(function() {
    const today = moment(new Date()).format().slice(0, 10);

    $('#calendar').fullCalendar({
      header: {
        left: 'prev,next today',
        center: 'title',
        right: 'month,agendaWeek,agendaDay'
      },
      defaultDate: today,
      navLinks: true, // can click day/week names to navigate views
      selectable: true,
      selectHelper: true,

      select: async function(start, end) {
        console.log(start);
        const {value: formValues} = await swal({
          title: 'Multiple inputs',
          html:
          '<span>Title: </span></span><input id="swal-input1" class="swal2-input">' +
          '<span>Description: </span><input id="swal-input2" class="swal2-input">' +
          '<span>start Time: </span><input id="swal-input3" class="swal2-input">' +
          '<span>end Time: </span><input id="swal-input4" class="swal2-input">',
          focusConfirm: false,
          preConfirm: () => {
            return [
              document.getElementById('swal-input1').value,
              document.getElementById('swal-input2').value,
              document.getElementById('swal-input3').value,
              document.getElementById('swal-input4').value
            ]
          }
        })

        let eventTitle = formValues[0]
        let eventDescription = formValues[1]
        let eventStartHr = twoDigit(formValues[2].split(':')[0]);
        let eventStartMin = twoDigit(formValues[2].split(':')[1]);
        let eventEndHr = twoDigit(formValues[3].split(':')[0]);
        let eventEndMin = twoDigit(formValues[3].split(':')[1]);

        const date = new Date(start._i);
        const year = date.getFullYear();
        let month = twoDigit(date.getMonth() + 1);
        let day = twoDigit(date.getDate());

        function twoDigit(value) {
          let validValue = value;
          if (value < 10) {
            validValue = `0${value}`
          }
          return validValue
        }

        const startTime = `${year}-${month}-${day}T${eventStartHr}:${eventStartMin}:00`
        const endTime = `${year}-${month}-${day}T${eventEndHr}:${eventEndMin}:00`
        var eventData = {
          title: eventTitle,
          description: eventDescription,
          start: startTime,
          end: endTime,
          user_id: user_id
        };
        console.log(eventData);
        if (eventData.title !== '' && eventData.start !== '' && eventData.end !== '') {
          $.ajax({
            url: '/events/ajax',
            headers: { 'X-CSRF-Token': '<%= form_authenticity_token.to_s %>' },
            method: 'POST',
            data: eventData
          })
          .then(function () {
              $('#calendar').fullCalendar('renderEvent', eventData, true); // stick? = true
              $('#calendar').fullCalendar('unselect');
            })
            .catch(function () {
              alert("Failed to save the data.");
            })
        }
      },

      eventClick: function(calEvent, jsEvent, view) {
        alert('Event: ' + calEvent.description);
        alert('Coordinates: ' + jsEvent.pageX + ',' + jsEvent.pageY);
        alert('View: ' + view.name);

        // change the border color just for fun
        $(this).css('border-color', 'red');
      },
      editable: true,
      eventLimit: true, // allow "more" link when too many events
      events: events
    });

  });

</script>
